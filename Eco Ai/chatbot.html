<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECO TRACK - Advanced AI Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'purple-primary': '#8E44AD',
                        'purple-dark': '#6C3483',
                        'purple-light': '#9B59B6',
                        'accent-blue': '#3498db',
                        'accent-dark': '#2E4457',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes starMove {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        @keyframes recordingPulse {
            0% { 
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0.7); 
                background: #e74c3c;
            }
            70% { 
                box-shadow: 0 0 0 10px rgba(231, 76, 60, 0); 
                background: #c0392b;
            }
            100% { 
                box-shadow: 0 0 0 0 rgba(231, 76, 60, 0); 
                background: #e74c3c;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .star-background {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a2e 50%, #16213e 100%);
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: starMove linear infinite;
        }

        .star:nth-child(1) { width: 2px; height: 2px; left: 10%; animation-duration: 15s; animation-delay: 0s; }
        .star:nth-child(2) { width: 3px; height: 3px; left: 20%; animation-duration: 20s; animation-delay: 2s; }
        .star:nth-child(3) { width: 1px; height: 1px; left: 30%; animation-duration: 25s; animation-delay: 4s; }
        .star:nth-child(4) { width: 2px; height: 2px; left: 40%; animation-duration: 18s; animation-delay: 6s; }
        .star:nth-child(5) { width: 4px; height: 4px; left: 50%; animation-duration: 22s; animation-delay: 8s; animation-name: twinkle, starMove; }
        .star:nth-child(6) { width: 2px; height: 2px; left: 60%; animation-duration: 16s; animation-delay: 10s; }
        .star:nth-child(7) { width: 1px; height: 1px; left: 70%; animation-duration: 24s; animation-delay: 12s; }
        .star:nth-child(8) { width: 3px; height: 3px; left: 80%; animation-duration: 19s; animation-delay: 14s; }
        .star:nth-child(9) { width: 2px; height: 2px; left: 90%; animation-duration: 21s; animation-delay: 16s; }
        .star:nth-child(10) { width: 1px; height: 1px; left: 15%; animation-duration: 17s; animation-delay: 18s; }

        /* Sidebar Styles */
        .sidebar {
            width: 72px;
            background: linear-gradient(180deg, rgb(25, 25, 25) 0%, rgb(35, 35, 35) 100%);
            transition: all 0.28s cubic-bezier(.2,.8,.2,1);
        }

        .sidebar:hover {
            width: 250px;
        }

        .sidebar-header img {
            width: 46px;
            max-width: 100%;
            height: auto;
            transition: all 0.3s ease;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3));
            object-fit: contain;
        }

        .sidebar:hover .sidebar-header img {
            width: 180px;
            max-width: 180px;
        }

        .nav-label {
            white-space: nowrap;
            overflow: hidden;
            opacity: 0;
            max-width: 0;
            transition: all 0.28s ease;
            font-weight: 500;
        }

        .sidebar:hover .nav-label {
            opacity: 1;
            max-width: 400px;
        }

        .nav-link {
            transition: all 0.3s cubic-bezier(.2,.8,.2,1);
            border-left: 3px solid transparent;
            position: relative;
            overflow: hidden;
        }

        .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(244, 208, 63, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            border-left-color: #f4d03f;
            transform: translateX(4px);
        }

        .nav-link:hover::before {
            opacity: 1;
        }

        .nav-link.active {
            background: linear-gradient(45deg, rgba(142, 68, 173, 0.3), rgba(155, 89, 182, 0.2));
            border-left-color: #9B59B6;
            color: #9B59B6;
        }

        /* Recording animation */
        .input-btn.recording {
            animation: recordingPulse 1s infinite;
        }

        /* Loading spinner */
        .simple-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(155, 89, 182, 0.3);
            border-top: 2px solid #9B59B6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        /* Message animation */
        .message {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Custom scrollbar */
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: rgba(155, 89, 182, 0.1);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: rgba(155, 89, 182, 0.5);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: rgba(155, 89, 182, 0.8);
        }
    </style>
</head>
<body class="flex h-screen bg-transparent text-gray-300 font-sans">
    <!-- Star Background -->
    <div class="star-background">
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
        <div class="star"></div>
    </div>

    <!-- Sidebar -->
    <nav class="sidebar fixed h-screen overflow-y-auto flex flex-col items-center z-50 shadow-2xl" aria-label="Main navigation">
        <div class="sidebar-header w-full p-2 border-b border-white border-opacity-10 mb-4 flex justify-center items-center min-h-[60px]">
            <img src="../images/logoo.png" alt="ECO TRACK company logo">
        </div>
        <ul class="nav-menu list-none p-0 w-full space-y-2">
            <li class="nav-item w-full">
                <a href="../Frontend/dashboard.html" class="nav-link flex items-center gap-3 p-3 text-white no-underline text-base w-full rounded-lg">
                    <span class="nav-icon w-7 h-7 flex items-center justify-center text-white">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
                        </svg>
                    </span>
                    <span class="nav-label text-white font-medium">Home</span>
                </a>
            </li>
            <li class="nav-item w-full">
                <a href="../Frontend/analysis.html" class="nav-link flex items-center gap-3 p-3 text-white no-underline text-base w-full rounded-lg">
                    <span class="nav-icon w-7 h-7 flex items-center justify-center text-white">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/>
                        </svg>
                    </span>
                    <span class="nav-label text-white font-medium">Analytics</span>
                </a>
            </li>
            <li class="nav-item w-full">
                <a href="../Frontend/report.html" class="nav-link flex items-center gap-3 p-3 text-white no-underline text-base w-full rounded-lg">
                    <span class="nav-icon w-7 h-7 flex items-center justify-center text-white">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M14,2H6A2,2 0 0,0 4,4V20A2,2 0 0,0 6,22H18A2,2 0 0,0 20,20V8L14,2M18,20H6V4H13V9H18V20Z"/>
                        </svg>
                    </span>
                    <span class="nav-label text-white font-medium">Reports</span>
                </a>
            </li>
            <li class="nav-item w-full">
                <a href="../Frontend/operation.html" class="nav-link flex items-center gap-3 p-3 text-white no-underline text-base w-full rounded-lg">
                    <span class="nav-icon w-7 h-7 flex items-center justify-center text-white">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,15.5A3.5,3.5 0 0,1 8.5,12A3.5,3.5 0 0,1 12,8.5A3.5,3.5 0 0,1 15.5,12A3.5,3.5 0 0,1 12,15.5M19.43,12.97C19.47,12.65 19.5,12.33 19.5,12C19.5,11.67 19.47,11.34 19.43,11L21.54,9.37C21.73,9.22 21.78,8.95 21.66,8.73L19.66,5.27C19.54,5.05 19.27,4.96 19.05,5.05L16.56,6.05C16.04,5.66 15.5,5.32 14.87,5.07L14.5,2.42C14.46,2.18 14.25,2 14,2H10C9.75,2 9.54,2.18 9.5,2.42L9.13,5.07C8.5,5.32 7.96,5.66 7.44,6.05L4.95,5.05C4.73,4.96 4.46,5.05 4.34,5.27L2.34,8.73C2.22,8.95 2.27,9.22 2.46,9.37L4.57,11C4.53,11.34 4.5,11.67 4.5,12C4.5,12.33 4.53,12.65 4.57,12.97L2.46,14.63C2.27,14.78 2.22,15.05 2.34,15.27L4.34,18.73C4.46,18.95 4.73,19.03 4.95,18.95L7.44,17.94C7.96,18.34 8.5,18.68 9.13,18.93L9.5,21.58C9.54,21.82 9.75,22 10,22H14C14.25,22 14.46,21.82 14.5,21.58L14.87,18.93C15.5,18.68 16.04,18.34 16.56,17.94L19.05,18.95C19.27,19.03 19.54,18.95 19.66,18.73L21.66,15.27C21.78,15.05 21.73,14.78 21.54,14.63L19.43,12.97Z"/>
                        </svg>
                    </span>
                    <span class="nav-label text-white font-medium">Operation</span>
                </a>
            </li>
            <li class="nav-item w-full">
                <a href="../Frontend/chatbot.html" class="nav-link active flex items-center gap-3 p-3 text-white no-underline text-base w-full rounded-lg">
                    <span class="nav-icon w-7 h-7 flex items-center justify-center text-white">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7H14A7,7 0 0,1 21,14H22A1,1 0 0,1 23,15V18A1,1 0 0,1 22,19H21V20A2,2 0 0,1 19,22H5A2,2 0 0,1 3,20V19H2A1,1 0 0,1 1,18V15A1,1 0 0,1 2,14H3A7,7 0 0,1 10,7H11V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2M7.5,13A2.5,2.5 0 0,0 5,15.5A2.5,2.5 0 0,0 7.5,18A2.5,2.5 0 0,0 10,15.5A2.5,2.5 0 0,0 7.5,13M16.5,13A2.5,2.5 0 0,0 14,15.5A2.5,2.5 0 0,0 16.5,18A2.5,2.5 0 0,0 19,15.5A2.5,2.5 0 0,0 16.5,13Z"/>
                        </svg>
                    </span>
                    <span class="nav-label text-white font-medium">Eco AI</span>
                </a>
            </li>
            <li class="nav-item w-full">
                <a href="../Frontend/settings.html" class="nav-link flex items-center gap-3 p-3 text-white no-underline text-base w-full rounded-lg">
                    <span class="nav-icon w-7 h-7 flex items-center justify-center text-white">
                        <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M3,17V19H9V17H3M3,5V7H13V5H3M13,21V19H21V17H13V15H11V21H13M7,9V11H3V13H7V15H9V9H7M21,13V11H11V13H21M15,9H17V7H21V5H17V3H15V9Z"/>
                        </svg>
                    </span>
                    <span class="nav-label text-white font-medium">Settings</span>
                </a>
            </li>
        </ul>
    </nav>
    
    <!-- Top Header -->
    <div class="fixed top-0 left-[72px] w-[calc(100%-72px)] h-[70px] bg-black bg-opacity-60 backdrop-blur-md border-b border-purple-light border-opacity-30 flex items-center justify-between px-8 gap-5 z-40 shadow-2xl transition-all duration-300">
        <img src="../images/logoo.png" alt="ECO TRACK outer logo" class="h-9 w-auto max-w-[200px] object-contain brightness-0 invert">
        <div class="flex items-center gap-4">
            <div class="flex items-center gap-3 cursor-pointer px-4 py-2 rounded-xl transition-all duration-300 bg-purple-light bg-opacity-20 backdrop-blur-md hover:bg-opacity-30 hover:-translate-y-0.5" onclick="toggleProfile()">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-primary to-purple-light flex items-center justify-center text-white font-bold text-base">
                    RA
                </div>
                <div class="flex flex-col">
                    <div class="text-sm font-semibold text-white">Ravi Admin</div>
                    <div class="text-xs text-white text-opacity-70">Administrator</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <main class="ml-[72px] mt-[70px] p-5 bg-transparent w-[calc(100%-72px)] min-h-[calc(100vh-70px)] transition-all duration-300 flex relative">
        <!-- Chat Container -->
        <div class="flex-1 flex flex-col bg-black bg-opacity-80 backdrop-blur-2xl rounded-2xl border border-purple-light border-opacity-30 overflow-hidden">
            
            <!-- Chat Header with Small Mode Toggle -->
            <div class="relative p-5 bg-purple-primary bg-opacity-20 border-b border-purple-light border-opacity-30">
                <!-- Mode Toggle - Small and Right Corner -->
                <div class="absolute top-3 right-3 flex bg-black bg-opacity-80 rounded-full p-1 border border-purple-light border-opacity-30">
                    <button class="mode-btn active px-2 py-1 text-xs rounded-full transition-all duration-300 text-white text-opacity-70 hover:text-white flex items-center gap-1" id="basicModeBtn" data-mode="basic">
                        <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>
                        </svg>
                        <span>Basic</span>
                    </button>
                    <button class="mode-btn px-2 py-1 text-xs rounded-full transition-all duration-300 text-white text-opacity-70 hover:text-white flex items-center gap-1" id="researchModeBtn" data-mode="research">
                        <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>
                        </svg>
                        <span>Research</span>
                    </button>
                </div>

                <!-- Title and Description -->
                <h2 class="text-white text-2xl font-bold mb-1 flex items-center gap-3 pr-24">
                    <svg class="w-6 h-6" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12,2A2,2 0 0,1 14,4C14,4.74 13.6,5.39 13,5.73V7H14A7,7 0 0,1 21,14H22A1,1 0 0,1 23,15V18A1,1 0 0,1 22,19H21V20A2,2 0 0,1 19,22H5A2,2 0 0,1 3,20V19H2A1,1 0 0,1 1,18V15A1,1 0 0,1 2,14H3A7,7 0 0,1 10,7H11V5.73C10.4,5.39 10,4.74 10,4A2,2 0 0,1 12,2M7.5,13A2.5,2.5 0 0,0 5,15.5A2.5,2.5 0 0,0 7.5,18A2.5,2.5 0 0,0 10,15.5A2.5,2.5 0 0,0 7.5,13M16.5,13A2.5,2.5 0 0,0 14,15.5A2.5,2.5 0 0,0 16.5,18A2.5,2.5 0 0,0 19,15.5A2.5,2.5 0 0,0 16.5,13Z"/>
                    </svg>
                    Advanced Eco AI Assistant
                </h2>
                <p class="text-white text-opacity-70 text-sm pr-24">
                    <span id="modeDescription">Quick and simple responses for everyday questions</span>
                </p>
            </div>
            
            <!-- Chat Messages -->
            <div class="chat-messages flex flex-col p-5 overflow-y-auto flex-1 space-y-4" id="chatMessages"></div>
            
            <!-- Chat Input -->
            <div class="p-5 bg-black bg-opacity-50 border-t border-purple-light border-opacity-30">
                <div class="flex items-center gap-3 bg-black bg-opacity-80 rounded-full border border-purple-light border-opacity-30 px-3 py-2 transition-all duration-300 focus-within:border-opacity-60 focus-within:shadow-lg focus-within:shadow-purple-light focus-within:shadow-opacity-20">
                    <button class="input-btn bg-transparent border-none cursor-pointer p-2 rounded-full transition-all duration-300 flex items-center justify-center w-9 h-9 text-purple-light hover:bg-purple-light hover:bg-opacity-20 hover:scale-110 hover:text-white" id="micBtn" title="Record Audio">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12,2A3,3 0 0,1 15,5V11A3,3 0 0,1 12,14A3,3 0 0,1 9,11V5A3,3 0 0,1 12,2M19,11C19,14.53 16.39,17.44 13,17.93V21H11V17.93C7.61,17.44 5,14.53 5,11H7A5,5 0 0,0 12,16A5,5 0 0,0 17,11H19Z"/>
                        </svg>
                    </button>
                    <input type="text" class="flex-1 bg-transparent border-none outline-none text-white text-base px-3 py-2 placeholder-white placeholder-opacity-50 focus:placeholder-opacity-30 transition-colors duration-300" id="chatInput" placeholder="Ask about sustainability, upload documents, or request visualizations..." />
                    <button class="input-btn bg-transparent border-none cursor-pointer p-2 rounded-full transition-all duration-300 flex items-center justify-center w-9 h-9 text-purple-light hover:bg-purple-light hover:bg-opacity-20 hover:scale-110 hover:text-white" id="attachBtn" title="Attach File">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M7.5,18A5.5,5.5 0 0,1 2,12.5A5.5,5.5 0 0,1 7.5,7H18A4,4 0 0,1 22,11A4,4 0 0,1 18,15H9.5A2.5,2.5 0 0,1 7,12.5A2.5,2.5 0 0,1 9.5,10H17V11.5H9.5A1,1 0 0,0 8.5,12.5A1,1 0 0,0 9.5,13.5H18A2.5,2.5 0 0,0 20.5,11A2.5,2.5 0 0,0 18,8.5H7.5A4,4 0 0,0 3.5,12.5A4,4 0 0,0 7.5,16.5H15V18H7.5Z"/>
                        </svg>
                    </button>
                    <button class="input-btn bg-transparent border-none cursor-pointer p-2 rounded-full transition-all duration-300 flex items-center justify-center w-9 h-9 text-purple-light hover:bg-purple-light hover:bg-opacity-20 hover:scale-110 hover:text-white" id="sendBtn" title="Send Message">
                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2,21L23,12L2,3V10L17,12L2,14V21Z"/>
                        </svg>
                    </button>
                </div>
                <input type="file" id="fileInput" class="hidden" accept=".txt,.pdf,.docx,.doc,.rtf" />
            </div>
        </div>
    </main>

<script>
// Wait for DOM to be fully loaded
document.addEventListener('DOMContentLoaded', function() {
    console.log('🚀 DOM loaded, initializing...');
    
    // --- ELEMENT REFERENCES ---
    const chatInput = document.getElementById('chatInput');
    const chatMessages = document.getElementById('chatMessages');
    const sendBtn = document.getElementById('sendBtn');
    const micBtn = document.getElementById('micBtn');
    const attachBtn = document.getElementById('attachBtn');
    const fileInput = document.getElementById('fileInput');
    const basicModeBtn = document.getElementById('basicModeBtn');
    const researchModeBtn = document.getElementById('researchModeBtn');
    const modeDescription = document.getElementById('modeDescription');

    // Check if all elements exist
    const elements = {
        chatInput, chatMessages, sendBtn, micBtn, attachBtn, 
        fileInput, basicModeBtn, researchModeBtn, modeDescription
    };
    
    for (const [name, element] of Object.entries(elements)) {
        if (!element) {
            console.error(`❌ Element not found: ${name}`);
            return;
        }
    }
    
    console.log('✅ All elements found');

    // --- STATE MANAGEMENT ---
    let chatHistory = [];
    let isRecording = false;
    let mediaRecorder;
    let audioChunks = [];
    let currentAudio = null;
    let currentMode = 'basic';

    // Mode descriptions
    const modeDescriptions = {
        basic: "Quick and simple responses for everyday questions",
        research: "Deep analysis with comprehensive research and detailed explanations"
    };

    // --- MODE SELECTION ---
    function setMode(mode) {
        console.log(`Setting mode to: ${mode}`);
        currentMode = mode;
        
        // Update UI
        document.querySelectorAll('.mode-btn').forEach(btn => btn.classList.remove('active'));
        if (mode === 'basic') {
            basicModeBtn.classList.add('active');
            basicModeBtn.classList.add('bg-purple-light', 'text-white');
            basicModeBtn.classList.remove('text-opacity-70');
            researchModeBtn.classList.remove('bg-purple-light', 'text-white');
            researchModeBtn.classList.add('text-opacity-70');
        } else {
            researchModeBtn.classList.add('active');
            researchModeBtn.classList.add('bg-purple-light', 'text-white');
            researchModeBtn.classList.remove('text-opacity-70');
            basicModeBtn.classList.remove('bg-purple-light', 'text-white');
            basicModeBtn.classList.add('text-opacity-70');
        }
        
        modeDescription.textContent = modeDescriptions[mode];
        
        // Update placeholder
        chatInput.placeholder = mode === 'research' 
            ? "Ask for detailed analysis, research insights, or comprehensive explanations..."
            : "Ask about sustainability, upload documents, or request visualizations...";
        
        console.log(`✅ Mode switched to: ${mode}`);
    }

    // Add event listeners for mode buttons
    basicModeBtn.addEventListener('click', function() {
        console.log('Basic mode button clicked');
        setMode('basic');
    });

    researchModeBtn.addEventListener('click', function() {
        console.log('Research mode button clicked');
        setMode('research');
    });

    // --- FILE UPLOAD HANDLING (ATTACHMENT ONLY) ---
    function handleFileUpload() {
        console.log('File upload triggered');
        const file = fileInput.files[0];
        if (!file) {
            console.log('No file selected');
            return;
        }

        console.log('File selected:', file.name, file.size, file.type);

        // Enhanced file validation
        const maxSize = 50 * 1024 * 1024; // 50MB
        if (file.size > maxSize) {
            addMessage('❌ Error: File size exceeds 50MB limit', 'ai');
            return;
        }

        const allowedExtensions = ['txt', 'pdf', 'docx', 'doc', 'rtf'];
        const fileExtension = file.name.split('.').pop().toLowerCase();
        if (!allowedExtensions.includes(fileExtension)) {
            addMessage('❌ Error: Unsupported file type. Please use TXT, PDF, DOCX, DOC, or RTF files.', 'ai');
            return;
        }

        addMessage(`<strong>📄 Uploading:</strong> ${file.name} (${formatFileSize(file.size)})`, 'user');

        const formData = new FormData();
        formData.append('file', file);

        const loadingMsg = createLoadingMessage('Processing document with AI analysis...');
        
        fetch('http://127.0.0.1:5000/upload-file', {
            method: 'POST',
            body: formData
        })
        .then(res => {
            console.log('Upload response status:', res.status);
            if (!res.ok) {
                throw new Error(`HTTP ${res.status}: ${res.statusText}`);
            }
            return res.json();
        })
        .then(data => {
            console.log('Upload response:', data);
            removeLoadingMessage(loadingMsg);
            
            if (data.status === 'success') {
                const fileInfo = `
                    <div class="mt-3 p-3 bg-purple-light bg-opacity-10 border border-purple-light border-opacity-30 rounded-lg text-sm leading-relaxed">
                        <strong class="text-purple-light">📊 Document Analysis:</strong><br>
                        ${data.analysis}
                        <br><br>
                        <small class="text-white text-opacity-60 block mt-2">📈 Content: ${data.content_length} characters | 📄 Type: ${data.file_type}</small>
                    </div>
                `;
                
                addMessage(`<strong>🤖 Analysis Complete:</strong>${fileInfo}`, 'ai', null, 'research');
                
                chatHistory.push({
                    user: `Uploaded document: ${data.filename}`,
                    ai: `Document analysis: ${data.analysis}`
                });
            } else {
                addMessage(`<strong>❌ Error:</strong> ${data.error}`, 'ai');
            }
        })
        .catch(error => {
            console.error('File upload error:', error);
            removeLoadingMessage(loadingMsg);
            addMessage(`❌ Upload failed: ${error.message}. Please check connection and try again.`, 'ai');
        });

        fileInput.value = '';
    }

    // File upload event listeners (ATTACHMENT ONLY)
    fileInput.addEventListener('change', handleFileUpload);
    
    attachBtn.addEventListener('click', function(e) {
        e.preventDefault();
        console.log('Attach button clicked');
        fileInput.click();
    });

    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // --- MESSAGE DISPLAY FUNCTIONS ---
    function addMessage(content, type, audioData = null, messageMode = null) {
        console.log('Adding message:', type, content.substring(0, 50) + '...');
        
        const messageDiv = document.createElement('div');
        let baseClasses = 'message max-w-4xl p-3 rounded-2xl break-words';
        
        if (type === 'user') {
            messageDiv.className = `${baseClasses} ml-auto bg-gradient-to-r from-purple-primary to-purple-light text-white`;
        } else {
            messageDiv.className = `${baseClasses} mr-auto bg-black bg-opacity-60 border border-purple-light border-opacity-30 text-white`;
            
            if (messageMode === 'research') {
                messageDiv.classList.add('border-l-4', 'border-l-accent-blue', 'bg-accent-blue', 'bg-opacity-5');
            } else if (messageMode === 'basic') {
                messageDiv.classList.add('border-l-4', 'border-l-green-400', 'bg-green-400', 'bg-opacity-5');
            }
        }
        
        const contentWrapper = document.createElement('div');
        contentWrapper.innerHTML = content;
        
        // Add mode indicator for AI responses
        if (type === 'ai' && messageMode) {
            const modeIndicator = document.createElement('div');
            modeIndicator.className = 'flex items-center gap-2 text-xs text-white text-opacity-60 mt-2';
            modeIndicator.innerHTML = `
                <svg class="w-3 h-3" viewBox="0 0 24 24" fill="currentColor">
                    ${messageMode === 'research' ? 
                        '<path d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z"/>' :
                        '<path d="M13,9H11V7H13M13,17H11V11H13M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z"/>'
                    }
                </svg>
                ${messageMode} mode
            `;
            contentWrapper.appendChild(modeIndicator);
        }
        
        // Add audio controls
        if (type === 'ai' && audioData) {
            const audioControls = createAudioControls(audioData);
            const controlsDiv = document.createElement('div');
            controlsDiv.className = 'flex items-center gap-2 mt-3';
            controlsDiv.appendChild(audioControls);
            contentWrapper.appendChild(controlsDiv);
        }
        
        messageDiv.appendChild(contentWrapper);
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // --- CHAT LOGIC ---
    async function handleUserInput(text, fromVoice = false) {
        console.log('Handling user input:', text);
        
        if (!text) return;
        
        if (!fromVoice) {
            addMessage(`<strong>👤 You:</strong> ${text}`, 'user');
        }
        
        const loadingText = currentMode === 'research' ? 
            'Conducting deep research analysis...' : 
            'Thinking...';
        const thinkingLoader = createLoadingMessage(loadingText);
        
        try {
            const response = await fetch('http://127.0.0.1:5000/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    message: text, 
                    history: chatHistory,
                    mode: currentMode
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Chat response:', data);
            removeLoadingMessage(thinkingLoader);
            
            if (data.reply_text) {
                addMessage(`<strong>🤖 Eco AI:</strong> ${data.reply_text}`, 'ai', data.reply_audio, data.mode_used);
                
                chatHistory.push({
                    user: text,
                    ai: data.reply_text
                });
                
                // Limit chat history
                if (chatHistory.length > 10) {
                    chatHistory = chatHistory.slice(-10);
                }
                
                // Auto-generate image if detected
                if (data.auto_generate_image && data.image_prompt) {
                    setTimeout(() => generateAndDisplayImage(data.image_prompt), 1000);
                }
            } else {
                addMessage(`<strong>❌ Error:</strong> ${data.error}`, 'ai');
            }
            
        } catch (error) {
            console.error('Chat error:', error);
            removeLoadingMessage(thinkingLoader);
            addMessage(`❌ Connection error: ${error.message}. Please try again.`, 'ai');
        }
    }

    // --- VOICE HANDLING ---
    micBtn.addEventListener('click', async function() {
        console.log('Microphone button clicked, isRecording:', isRecording);
        
        if (isRecording) {
            console.log('Stopping recording');
            mediaRecorder.stop();
            micBtn.classList.remove('recording');
            isRecording = false;
            return;
        }

        try {
            console.log('Starting recording...');
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    autoGainControl: true,
                    sampleRate: 16000
                }
            });
            
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: MediaRecorder.isTypeSupported('audio/webm;codecs=opus') ? 
                          'audio/webm;codecs=opus' : 'audio/webm'
            });
            
            audioChunks = [];
            isRecording = true;
            micBtn.classList.add('recording');

            const listeningLoader = createLoadingMessage('Listening...');

            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };

            mediaRecorder.onstop = async () => {
                console.log('Recording stopped, processing...');
                updateLoadingMessage(listeningLoader, 'Processing speech...');
                
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const formData = new FormData();
                formData.append('audio_data', audioBlob, 'recording.webm');

                try {
                    const response = await fetch('http://127.0.0.1:5000/transcribe', {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('Transcription response:', data);
                    removeLoadingMessage(listeningLoader);
                    
                    if (data.transcribed_text) {
                        addMessage(`<strong>🎤 Voice Input:</strong> Processing...`, 'user');
                        
                        // Process the transcribed text
                        setTimeout(() => {
                            handleUserInput(data.transcribed_text, true);
                        }, 300);
                    } else {
                        addMessage(`<strong>❌ Error:</strong> Could not understand audio - ${data.error || 'Please speak more clearly'}`, 'ai');
                    }
                } catch (error) {
                    console.error('Transcription error:', error);
                    removeLoadingMessage(listeningLoader);
                    addMessage(`❌ Voice processing failed: ${error.message}. Please try again.`, 'ai');
                }

                stream.getTracks().forEach(track => track.stop());
            };

            mediaRecorder.start();
            console.log('Recording started');
            
            // Auto-stop after 30 seconds
            setTimeout(() => {
                if (isRecording) {
                    console.log('Auto-stopping recording after 30 seconds');
                    mediaRecorder.stop();
                    micBtn.classList.remove('recording');
                    isRecording = false;
                }
            }, 30000);
            
        } catch (error) {
            console.error('Microphone error:', error);
            alert('Could not access microphone. Please check permissions and try again.');
            isRecording = false;
            micBtn.classList.remove('recording');
        }
    });

    // --- TEXT INPUT HANDLING ---
    sendBtn.addEventListener('click', function() {
        console.log('Send button clicked');
        const text = chatInput.value.trim();
        if (text) {
            handleUserInput(text);
            chatInput.value = '';
        }
    });

    chatInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendBtn.click();
        }
    });

    // --- IMAGE GENERATION ---
    async function generateAndDisplayImage(prompt) {
        console.log('Generating image for prompt:', prompt);
        const imageLoader = createLoadingMessage('Creating high-quality visualization...');
        
        try {
            const response = await fetch('http://127.0.0.1:5000/generate-image', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    prompt,
                    style: 'professional'
                })
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('Image generation response:', data);
            removeLoadingMessage(imageLoader);
            
            if (data.image_url) {
                const lastMessage = chatMessages.querySelector('.message:last-child');
                if (lastMessage) {
                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'mt-3';
                    
                    const imageElement = document.createElement('img');
                    imageElement.src = data.image_url;
                    imageElement.className = 'max-w-full rounded-xl cursor-pointer transition-all duration-300 shadow-lg hover:scale-102 hover:shadow-purple-light hover:shadow-opacity-40';
                    imageElement.onclick = () => window.open(data.image_url, '_blank');
                    imageElement.title = `Generated: ${prompt}`;
                    imageElement.alt = `AI generated image for: ${prompt}`;
                    
                    imageElement.onload = () => {
                        imageElement.style.opacity = '1';
                    };
                    imageElement.style.opacity = '0.5';
                    imageElement.style.transition = 'opacity 0.3s ease';
                    
                    imageContainer.appendChild(imageElement);
                    lastMessage.appendChild(imageContainer);
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }
            }
        } catch (error) {
            console.error('Image generation error:', error);
            removeLoadingMessage(imageLoader);
            addMessage(`❌ Image generation failed: ${error.message}`, 'ai');
        }
    }

    // --- UTILITY FUNCTIONS ---
    function createLoadingMessage(text) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message max-w-4xl p-3 rounded-2xl mr-auto bg-black bg-opacity-60 border border-purple-light border-opacity-30 text-white`;
        messageDiv.innerHTML = `
            <strong>🤖 Eco AI:</strong> 
            <div class="flex items-center gap-3 mt-2">
                <div class="simple-spinner"></div>
                <span class="text-white text-opacity-80 italic">${text}</span>
            </div>
        `;
        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
        return messageDiv;
    }

    function removeLoadingMessage(element) {
        if (element && element.parentNode) {
            element.style.opacity = '0';
            element.style.transform = 'translateY(-10px)';
            setTimeout(() => {
                if (element.parentNode) {
                    element.parentNode.removeChild(element);
                }
            }, 200);
        }
    }

    function updateLoadingMessage(element, newText) {
        if (element) {
            const textElement = element.querySelector('.simple-loading span, span');
            if (textElement) {
                textElement.style.opacity = '0';
                setTimeout(() => {
                    textElement.textContent = newText;
                    textElement.style.opacity = '1';
                }, 100);
            }
        }
    }

    function createAudioControls(base64Audio) {
        const audio = new Audio(`data:audio/mpeg;base64,${base64Audio}`);
        const playBtn = document.createElement('button');
        playBtn.className = 'w-9 h-9 rounded-full bg-gradient-to-r from-purple-primary to-purple-light text-white flex items-center justify-center cursor-pointer transition-all duration-300 hover:scale-110 hover:shadow-lg hover:shadow-purple-light hover:shadow-opacity-40';
        playBtn.title = 'Play/Pause audio response';
        playBtn.innerHTML = `
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                <path d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
            </svg>
        `;
        
        playBtn.onclick = () => {
            if (currentAudio && currentAudio !== audio && !currentAudio.paused) {
                currentAudio.pause();
            }
            
            if (audio.paused) {
                audio.play();
                currentAudio = audio;
                playBtn.innerHTML = `
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M14,19H18V5H14M6,19H10V5H6V19Z"/>
                    </svg>
                `;
            } else {
                audio.pause();
                playBtn.innerHTML = `
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
                    </svg>
                `;
            }
        };
        
        audio.onended = () => {
            playBtn.innerHTML = `
                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M8,5.14V19.14L19,12.14L8,5.14Z"/>
                </svg>
            `;
        };
        
        return playBtn;
    }

    // --- INITIALIZATION ---
    console.log('🚀 Advanced Eco AI Assistant initialized');
    
    // Health check
    fetch('http://127.0.0.1:5000/health')
        .then(res => res.json())
        .then(data => {
            console.log('✅ Server status:', data);
            
            setTimeout(() => {
                addMessage(
                    '<strong>🤖 Advanced Eco AI:</strong> Welcome to the enhanced sustainability assistant! Choose between Basic mode for quick answers or Research mode for comprehensive analysis. I can process documents and provide detailed insights on environmental topics.', 
                    'ai', null, 'basic'
                );
            }, 800);
        })
        .catch(err => {
            console.error('❌ Server check failed:', err);
            addMessage('⚠️ Server connection issue. Some features may be limited. Please ensure the backend is running on port 5000.', 'ai');
        });
    
    // Set initial focus
    chatInput.focus();
    
    console.log('✅ Initialization complete');
});

// Profile toggle function
function toggleProfile() {
    console.log('Profile clicked - Add profile dropdown functionality here');
}

// Global error handling
window.addEventListener('error', (e) => {
    console.error('Uncaught error:', e.error);
});
</script>

</body>
</html>
